const i=process.env.PUBLIC_URL,e=`${i}/assets/`;const t=(t,a)=>{const n=t.map(((t,n)=>{const l=function(i,t){const a=function(i,e){const t=i.find((i=>i.title===e));return!!t&&t.id}(i,t);return a?{id:`${e}${a}.json`,type:"AnnotationPage"}:null}(a,t.title);return{id:`${i}/iiif/canvas/${n+1}`,label:{none:[`${n+1}`]},filename:`${t.filename_download}`,type:"Canvas",height:t.height,width:t.width,thumbnail:[{id:`${e}${t.id}?key=thumbnail`,type:"Image",format:"image/png",width:100,height:Math.round(100*t.height/t.width)}],items:[{id:`${i}/iiif/image/page/${n+1}`,type:"AnnotationPage",items:[{id:`${i}/iiif/image/${n+1}`,type:"Annotation",motivation:"painting",body:{id:`${e}${t.id}?format=jpg`,type:"Image",format:"image/jpeg",height:t.height,width:t.width},target:`${i}/iiif/canvas/${n+1}`}]}],...l?{annotations:[l]}:{},seeAlso:[{id:`${e}e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4`,type:"Text",format:"text/plain"}],rendering:[{id:`${e}e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4`,type:"Text",label:{en:["Download as TXT"]},format:"text/plain"}]}}));return n};var a={id:"iiif",handler:(e,{services:a,exceptions:n})=>{const{ItemsService:l}=a;e.get("/",((i,e)=>e.send("IIIF"))),e.get("/manifest/:collection/:file_id",(async function(e,a,n){const o=e.params.file_id,s=e.params.collection,d=new l("IIIF_settings",{schema:e.schema,accountability:e.accountability}),c=new l(s,{schema:e.schema,accountability:e.accountability}),f=new l("directus_files",{schema:e.schema,accountability:e.accountability}),m=await d.readByQuery({filter:{iiif_collection:{_eq:s}}}),{iiif_file:r,iiif_canvas_label:h,iiif_meta:p,annotation_files:_,alto_files:u,txt_files:$}=m[0],g=[`${r}.*`,h,`${_}.*`,`${u}.*`,`${$}.*`];console.log(o,"fileId"),console.log(s,"collection"),console.log(r,"iiif_file"),console.log(h,"iiif_canvas_label"),console.log(p,"iiif_meta"),console.log(_,"annotation_files"),console.log(u,"alto_files"),console.log($,"txt_files"),p.map((i=>g.push(`${i.Value}`)));const w=await c.readOne(o,{fields:g,limit:-1,deep:{[r]:{_limit:-1},[_]:{_limit:-1},[$]:{_limit:-1},[u]:{_limit:-1}}}),y=w[r],b=w[`${_}`],v=w[`${$}`],I=w[`${u}`],x=w[h],P=[],O=[],j=[],A=[];await Promise.all(y.map((async i=>{const e=await f.readOne(i.directus_files_id,{fields:["id","width","height","title","filename_download","author","date"]});P.push(e)})));var T=[];void 0!==b&&(await Promise.all(b.map((async i=>{const e=await f.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});O.push(e)}))),T=O.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==v&&(await Promise.all(v.map((async i=>{const e=await f.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});A.push(e)}))),A.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==I&&(await Promise.all(I.map((async i=>{const e=await f.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});j.push(e)}))),j.sort(((i,e)=>i.title>e.title?1:-1)));const B=p.map((i=>{const e=[];return e.push(`${i.Key}`,w[`${i.Value}`]),e})),C=P.sort(((i,e)=>i.title>e.title?1:-1)),F=t(C,T);a.send(((e,t,a,n,l,o)=>{const s=l.map((i=>({label:{et:[`${i[0]}`]},value:{et:[`${i[1]}`]}})));return{"@context":"http://iiif.io/api/presentation/3/context.json",sorted:o,id:`${i}/iiif/manifest/${a}/${n}`,type:"Manifest",label:{et:[`${e}`]},metadata:s,items:t}})(x,F,s,o,B))}))}};export{a as default};
