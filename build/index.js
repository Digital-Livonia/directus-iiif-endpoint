const i=process.env.PUBLIC_URL,e=`${i}/assets/`;function t(i,t){const a=function(i,e){console.log(e,"filename_download"),console.log(i,"annotations");const t=i.find((i=>i.filename_download===e));return!!t&&t.id}(i,t);return a?{id:`${e}${a}.json`,type:"AnnotationPage"}:null}var a={id:"iiif",handler:(a,{services:n,exceptions:o})=>{const{ItemsService:l}=n;a.get("/",((i,e)=>e.send("IIIF"))),a.get("/manifest/:collection/:file_id",(async function(a,n,o){const s=a.params.file_id,d=a.params.collection,c=new l("IIIF_settings",{schema:a.schema,accountability:a.accountability}),m=new l(d,{schema:a.schema,accountability:a.accountability}),r=new l("directus_files",{schema:a.schema,accountability:a.accountability}),f=await c.readByQuery({filter:{iiif_collection:{_eq:d}}}),{iiif_file:p,iiif_canvas_label:h,iiif_meta:$,annotation_files:_,alto_files:u,txt_files:w}=f[0],g=[`${p}.*`,h,`${_}.*`,`${u}.*`,`${w}.*`];$.map((i=>g.push(`${i.Value}`)));const y=await m.readOne(s,{fields:g,limit:-1,deep:{[p]:{_limit:-1},[_]:{_limit:-1},[w]:{_limit:-1},[u]:{_limit:-1}}}),b=y[p],v=y[`${_}`],I=y[`${w}`],P=y[`${u}`],x=y[h],j=[],O=[],A=[],C=[];await Promise.all(b.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","width","height","title","filename_download","author","date"]});j.push(e)})));let U=[];void 0!==v&&(await Promise.all(v.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});O.push(e)}))),U=O.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==I&&(await Promise.all(I.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});C.push(e)}))),C.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==P&&(await Promise.all(P.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});A.push(e)}))),A.sort(((i,e)=>i.title>e.title?1:-1)));const B=$.map((i=>{const e=[];return e.push(`${i.Key}`,y[`${i.Value}`]),e})),F=j.sort(((i,e)=>i.title>e.title?1:-1)),L=(M=U,F.map(((a,n)=>{const o=a.filename_download.split(".")[0]+".json",l=t(M,o),s=[{id:`${e}${a.id}?download=${a.filename_download}`,type:"Text",label:{en:[`Download original (${a.filename_download.split(".").pop().toUpperCase()})`]},format:a.type}];return{id:`${i}/iiif/canvas/${n+1}`,label:{none:[`${n+1}`]},filename:`${a.filename_download}`,type:"Canvas",height:a.height,width:a.width,thumbnail:[{id:`${e}${a.id}?key=thumbnail`,type:"Image",format:"image/png",width:100,height:Math.round(100*a.height/a.width)}],items:[{id:`${i}/iiif/image/page/${n+1}`,type:"AnnotationPage",items:[{id:`${i}/iiif/image/${n+1}`,type:"Annotation",motivation:"painting",body:{id:`${e}${a.id}?format=jpg`,type:"Image",format:"image/jpeg",height:a.height,width:a.width},target:`${i}/iiif/canvas/${n+1}`}]}],...l?{annotations:[l]}:{},rendering:s}})));var M;n.send(((e,t,a,n,o,l)=>{const s=o.map((i=>({label:{et:[`${i[0]}`]},value:{et:[`${i[1]}`]}})));return{"@context":"http://iiif.io/api/presentation/3/context.json",sorted:l,id:`${i}/iiif/manifest/${a}/${n}`,type:"Manifest",label:{et:[`${e}`]},metadata:s,items:t}})(x,L,d,s,B))}))}};export{a as default};
