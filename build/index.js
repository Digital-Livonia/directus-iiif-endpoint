const i=process.env.PUBLIC_URL,e=`${i}/assets/`;function t(i,t){const a=function(i,e){console.log(e,"filename_download"),console.log(i,"annotations");const t=i.find((i=>i.filename_download===e));return!!t&&t.id}(i,t);return a?{id:`${e}${a}.json`,type:"AnnotationPage"}:null}var a={id:"iiif",handler:(a,{services:n,exceptions:l})=>{const{ItemsService:o}=n;a.get("/",((i,e)=>e.send("IIIF"))),a.get("/manifest/:collection/:file_id",(async function(a,n,l){const s=a.params.file_id,d=a.params.collection,c=new o("IIIF_settings",{schema:a.schema,accountability:a.accountability}),m=new o(d,{schema:a.schema,accountability:a.accountability}),r=new o("directus_files",{schema:a.schema,accountability:a.accountability}),f=await c.readByQuery({filter:{iiif_collection:{_eq:d}}}),{iiif_file:p,iiif_canvas_label:h,iiif_meta:u,annotation_files:$,alto_files:_,txt_files:w}=f[0],g=[`${p}.*`,h,`${$}.*`,`${_}.*`,`${w}.*`];u.map((i=>g.push(`${i.Value}`)));const y=await m.readOne(s,{fields:g,limit:-1,deep:{[p]:{_limit:-1},[$]:{_limit:-1},[w]:{_limit:-1},[_]:{_limit:-1}}}),b=y[p],v=y[`${$}`],I=y[`${w}`],x=y[`${_}`],P=y[h],j=[],O=[],A=[],T=[];await Promise.all(b.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","width","height","title","filename_download","author","date"]});j.push(e)})));let B=[];void 0!==v&&(await Promise.all(v.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});O.push(e)}))),B=O.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==I&&(await Promise.all(I.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});T.push(e)}))),T.sort(((i,e)=>i.title>e.title?1:-1))),void 0!==x&&(await Promise.all(x.map((async i=>{const e=await r.readOne(i.directus_files_id,{fields:["id","title","filename_download"]});A.push(e)}))),A.sort(((i,e)=>i.title>e.title?1:-1)));const C=u.map((i=>{const e=[];return e.push(`${i.Key}`,y[`${i.Value}`]),e})),F=((a,n)=>{const l=a.map(((a,l)=>{const o=a.filename_download.split(".")[0]+".json",s=t(n,o);return{id:`${i}/iiif/canvas/${l+1}`,label:{none:[`${l+1}`]},filename:`${a.filename_download}`,type:"Canvas",height:a.height,width:a.width,thumbnail:[{id:`${e}${a.id}?key=thumbnail`,type:"Image",format:"image/png",width:100,height:Math.round(100*a.height/a.width)}],items:[{id:`${i}/iiif/image/page/${l+1}`,type:"AnnotationPage",items:[{id:`${i}/iiif/image/${l+1}`,type:"Annotation",motivation:"painting",body:{id:`${e}${a.id}?format=jpg`,type:"Image",format:"image/jpeg",height:a.height,width:a.width},target:`${i}/iiif/canvas/${l+1}`}]}],...s?{annotations:[s]}:{},seeAlso:[{id:`${e}e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4`,type:"Text",format:"text/plain"}],rendering:[{id:`${e}e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4`,type:"Text",label:{en:["Download as TXT"]},format:"text/plain"}]}}));return l})(j.sort(((i,e)=>i.title>e.title?1:-1)),B);n.send(((e,t,a,n,l,o)=>{const s=l.map((i=>({label:{et:[`${i[0]}`]},value:{et:[`${i[1]}`]}})));return{"@context":"http://iiif.io/api/presentation/3/context.json",sorted:o,id:`${i}/iiif/manifest/${a}/${n}`,type:"Manifest",label:{et:[`${e}`]},metadata:s,items:t}})(P,F,d,s,C))}))}};export{a as default};
