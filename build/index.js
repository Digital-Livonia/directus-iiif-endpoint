function e(e,t){const i=e.find((e=>e.title===t));return i?i.id:null}const t=(t,i)=>{const a=t.map(((t,a)=>{const l=function(t,i){return t.length>0?{id:`https://dev.db.dl.tlu.ee/assets/${e(t,i)}.json`,type:"AnnotationPage"}:null}(i,t.title);return{id:`https://dev.db.dl.tlu.ee/iiif/canvas/${a+1}`,label:{none:[`${a+1}`]},filename:`${t.filename_download}`,type:"Canvas",height:t.height,width:t.width,thumbnail:[{id:`https://dev.db.dl.tlu.ee/assets/${t.id}?key=thumbnail`,type:"Image",format:"image/png",width:100,height:Math.round(100*t.height/t.width)}],items:[{id:`https://dev.db.dl.tlu.ee/iiif/image/page/${a+1}`,type:"AnnotationPage",items:[{id:`https://dev.db.dl.tlu.ee/iiif/image/${a+1}`,type:"Annotation",motivation:"painting",body:{id:`https://dev.db.dl.tlu.ee/assets/${t.id}?format=jpg`,type:"Image",format:"image/jpeg",height:t.height,width:t.width},target:`https://dev.db.dl.tlu.ee/iiif/canvas/${a+1}`}]}],...l?{annotations:[l]}:{},seeAlso:[{id:"https://dev.db.dl.tlu.ee/assets/e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4",type:"Text",format:"text/plain"}],rendering:[{id:"https://dev.db.dl.tlu.ee/assets/e48bc0d7-4cfb-460d-8c5b-00eeb148ddd4",type:"Text",label:{en:["Download as TXT"]},format:"text/plain"}]}}));return a};var i={id:"iiif",handler:(e,{services:i,exceptions:a})=>{const{ItemsService:l}=i;e.get("/",((e,t)=>t.send("IIIF"))),e.get("/manifest/:collection/:file_id",(async function(e,i,a){const n=e.params.file_id,s=e.params.collection,d=new l("IIIF_settings",{schema:e.schema,accountability:e.accountability}),o=new l(s,{schema:e.schema,accountability:e.accountability}),c=new l("directus_files",{schema:e.schema,accountability:e.accountability}),f=await d.readByQuery({filter:{iiif_collection:{_eq:s}}}),{iiif_file:m,iiif_canvas_label:r,iiif_meta:h,annotation_files:p,alto_files:u,txt_files:_}=f[0],g=[`${m}.*`,r,`${p}.*`,`${u}.*`,`${_}.*`];console.log(n,"fileId"),console.log(s,"collection"),console.log(m,"iiif_file"),console.log(r,"iiif_canvas_label"),console.log(h,"iiif_meta"),console.log(p,"annotation_files"),console.log(u,"alto_files"),console.log(_,"txt_files"),h.map((e=>g.push(`${e.Value}`)));const b=await o.readOne(n,{fields:g,limit:-1,deep:{[m]:{_limit:-1},[p]:{_limit:-1},[_]:{_limit:-1},[u]:{_limit:-1}}}),w=b[m],y=b[`${p}`],v=b[`${_}`],$=b[`${u}`],x=b[r],I=[],P=[],O=[],j=[];await Promise.all(w.map((async e=>{const t=await c.readOne(e.directus_files_id,{fields:["id","width","height","title","filename_download","author","date"]});I.push(t)})));var A=[];void 0!==y&&(await Promise.all(y.map((async e=>{const t=await c.readOne(e.directus_files_id,{fields:["id","title","filename_download"]});P.push(t)}))),A=P.sort(((e,t)=>e.title>t.title?1:-1))),void 0!==v&&(await Promise.all(v.map((async e=>{const t=await c.readOne(e.directus_files_id,{fields:["id","title","filename_download"]});j.push(t)}))),j.sort(((e,t)=>e.title>t.title?1:-1))),void 0!==$&&(await Promise.all($.map((async e=>{const t=await c.readOne(e.directus_files_id,{fields:["id","title","filename_download"]});O.push(t)}))),O.sort(((e,t)=>e.title>t.title?1:-1)));const T=h.map((e=>{const t=[];return t.push(`${e.Key}`,b[`${e.Value}`]),t})),F=I.sort(((e,t)=>e.title>t.title?1:-1)),M=t(F,A);i.send(((e,t,i,a,l,n)=>({"@context":"http://iiif.io/api/presentation/3/context.json",sorted:n,id:`https://dev.db.dl.tlu.ee/iiif/manifest/${i}/${a}`,type:"Manifest",label:{et:[`${e}`]},metadata:l.map((e=>({label:{et:[`${e[0]}`]},value:{et:[`${e[1]}`]}}))),items:t}))(x,M,s,n,T))}))}};export{i as default};
